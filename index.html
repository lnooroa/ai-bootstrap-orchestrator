<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f7f7f7;
    }
    header {
      background: #222; color: #fff; padding: 10px;
    }
    .controls {
      display: flex; gap: 10px; align-items: center;
      padding: 10px; background: #eee;
    }
    .controls select, .controls input, .controls button {
      padding: 6px;
    }
    #messages {
      padding: 10px;
      height: 400px; overflow-y: auto;
      background: #fff;
    }
    .msg {
      padding: 8px 10px; margin: 5px 0;
      border-radius: 6px;
      max-width: 80%;
    }
    .msg-user {
      background: #d1e7dd; align-self: flex-end;
    }
    .msg-ai {
      background: #e2e3e5; align-self: flex-start;
    }
    #statusBar {
      padding: 6px 10px; font-size: 0.9em;
    }
    .status-success { color: green; }
    .status-error { color: red; }
    .status-info { color: #555; }
    .input-bar {
      display: flex; gap: 10px; padding: 10px;
      background: #eee;
    }
    .input-bar textarea {
      flex: 1; padding: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h2>AI Assistant</h2>
  </header>

  <!-- Provider & API key controls -->
  <div class="controls">
    <label for="aiProvider">Provider:</label>
    <select id="aiProvider">
      <option value="openai">OpenAI GPT-4o-mini</option>
      <option value="gemini">Gemini 2.5 Flash-Lite</option>
      <option value="deepseek">DeepSeek Chat</option>
    </select>

    <input type="password" id="apiKey" placeholder="Optional API key" />
    <button id="secureActivateBtn">Secure & Activate AI</button>
  </div>

  <!-- Chat messages -->
  <div id="messages"></div>

  <!-- Status bar -->
  <div id="statusBar" class="status-info">Ready.</div>

  <!-- Input bar -->
  <div class="input-bar">
    <textarea id="userInput" rows="2" placeholder="Type your message..."></textarea>
    <button id="sendBtn">Send</button>
  </div>

  <!-- Full Script -->
  <script>
  const PROXY_ENDPOINT = "/.netlify/functions/ai-proxy";

  const AI_PROVIDERS = {
    openai:  { id: "openai",  name: "OpenAI",  model: "gpt-4o-mini" },
    gemini:  { id: "gemini",  name: "Gemini",  model: "gemini-2.5-flash-lite" },
    deepseek:{ id: "deepseek",name: "DeepSeek",model: "deepseek-chat" }
  };

  const apiConfig = { provider: "openai", apiKeyCipher: null };

  function $(sel){ return document.querySelector(sel); }
  function showStatus(msg, type="info"){
    const el=$("#statusBar");
    if(!el) return console.log(`[${type}] ${msg}`);
    el.textContent=msg; el.className="";
    el.classList.add(type==="error"?"status-error":type==="success"?"status-success":"status-info");
  }
  function addMessage(role,text){
    const wrap=$("#messages"); if(!wrap) return console.log(`${role}:`,text);
    const item=document.createElement("div");
    item.className=role==="user"?"msg msg-user":"msg msg-ai";
    item.textContent=text; wrap.appendChild(item); wrap.scrollTop=wrap.scrollHeight;
  }
  function incrementUsage(){}
  function updateCode(){} function addFileTab(){} function switchToFile(){}

  function encryptApiKey(p){try{return btoa(unescape(encodeURIComponent(p)));}catch{return null;}}
  function decryptApiKey(c){try{return decodeURIComponent(escape(atob(c)));}catch{return null;}}

  function readProviderFromUI(){
    const sel=$("#aiProvider");
    if(sel&&sel.value) apiConfig.provider=sel.value.toLowerCase();
    if(!AI_PROVIDERS[apiConfig.provider]) apiConfig.provider="openai";
    return apiConfig.provider;
  }
  function readKeyFromUI(){const input=$("#apiKey");return input&&input.value?input.value.trim():"";}

  async function callAIProxy({provider,model,message,system,apiKeyOverride}){
    const payload={provider,model,message,system:system||"You are an AI development assistant."};
    if(apiKeyOverride) payload.apiKey=apiKeyOverride;
    const res=await fetch(PROXY_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const txt=await res.text(); let data; try{data=JSON.parse(txt);}catch{throw new Error(`Proxy non-JSON: ${txt}`);}
    if(!res.ok){throw new Error(data?.error||res.status+" "+txt);} return data;
  }

  async function callRealAI(message){
    showStatus("AI is processingâ€¦","info");
    try{
      const providerId=readProviderFromUI();
      const provider=AI_PROVIDERS[providerId];
      const apiKey=apiConfig.apiKeyCipher?decryptApiKey(apiConfig.apiKeyCipher):null;
      if(!message||!message.trim()) throw new Error("Please enter a prompt.");
      incrementUsage();
      const data=await callAIProxy({provider:provider.id,model:provider.model,message:message.trim(),apiKeyOverride:apiKey||undefined});
      const text=(data&&typeof data.text==="string"&&data.text.trim())?data.text.trim():extractResponseText(data,provider.id);
      addMessage("ai",text);
      showStatus(`AI response from ${data.provider} (${data.model}).`,"success");
      return text;
    }catch(err){console.error(err);showStatus(err.message||"AI request failed.","error");throw err;}
  }

  function extractResponseText(data,provider){
    const raw=data?.raw||data;
    if(provider==="gemini"){
      const parts=raw?.candidates?.[0]?.content?.parts;
      if(Array.isArray(parts)) return parts.map(p=>p?.text||"").join("").trim()||"No response.";
      return raw?.candidates?.[0]?.content?.parts?.[0]?.text||"No response.";
    }
    return raw?.choices?.[0]?.message?.content||"No response.";
  }

  function wireUI(){
    const sel=$("#aiProvider");
    if(sel){sel.addEventListener("change",()=>{readProviderFromUI();showStatus(`Provider set to ${AI_PROVIDERS[apiConfig.provider].name}.`,"success");}); readProviderFromUI();}
    const btn=$("#secureActivateBtn");
    if(btn){btn.addEventListener("click",()=>{const key=readKeyFromUI();if(!key){apiConfig.apiKeyCipher=null;showStatus("API key cleared.","success");return;}
      const cipher=encryptApiKey(key); if(!cipher)return showStatus("Failed to secure API key.","error");
      apiConfig.apiKeyCipher=cipher; showStatus(`${AI_PROVIDERS[apiConfig.provider].name} configured securely!`,"success");});}
    const send=$("#sendBtn"),input=$("#userInput");
    if(send&&input){send.addEventListener("click",async()=>{const msg=input.value;if(!msg.trim())return showStatus("Enter a prompt.","error");addMessage("user",msg.trim());input.value="";try{await callRealAI(msg);}catch{}});}
  }
  document.addEventListener("DOMContentLoaded",wireUI);

  window.callRealAI=callRealAI;
  </script>
</body>
</html>
